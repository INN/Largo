window.console||(console={log:function(){}});var LFM=_.extend(LFM||{},{Utils:{},Views:{},Models:{},Controller:{},instances:{},fetching:!1});!function(){var s,l=jQuery,i=_wpMediaViewsL10n;0 in document;LFM.Models.featuredMediaModel=s=Backbone.Model.extend({initialize:function(){Backbone.Model.prototype.initialize.apply(this,arguments),this.set({id:LFM.Utils.getPostId()})},url:ajaxurl,sync:function(e,t,i){var a,t="create"==e||"update"==e?t.toJSON():{};if(t=_.extend(t,{id:LFM.Utils.getPostId()}),"read"==e)a="largo_featured_media_read";else{if("update"!=e&&"create"!=e)return!1;a="largo_featured_media_save"}e=i.success,i=i.error;LFM.Utils.doAjax(a,t,e,i)}}),LFM.Views.featuredMediaFrame=wp.media.view.MediaFrame.Select.extend({initialize:function(){_.defaults(this.options,{multiple:!0,editing:!1,state:"image",metadata:{},className:"featured-media-modal",model:new s,states:["embed-code","video","image","gallery"]}),wp.media.view.MediaFrame.Select.prototype.initialize.apply(this,arguments),this.createIframeStates(),this.$el.addClass(this.options.className)},createStates:function(){var e=this.options,t=[new wp.media.controller.FeaturedImage({title:largo_featured_media_vars.image_title,id:"image",priority:10}),new wp.media.controller.EditImage({model:e.editImage})],i=[new wp.media.controller.Library({title:largo_featured_media_vars.gallery_title,id:"gallery",priority:20,toolbar:"main-gallery",filterable:"uploaded",multiple:"add",editable:!1,library:wp.media.query(_.defaults({type:"image"},e.library))}),new wp.media.controller.GalleryEdit({library:e.selection,editing:e.editing,menu:"gallery"}),new wp.media.controller.GalleryAdd],a=[new wp.media.controller.Embed({title:largo_featured_media_vars.video_title,id:"video",priority:30,content:"video"})],r=[new wp.media.controller.Embed({title:largo_featured_media_vars.embed_title,id:"embed-code",priority:40,content:"embed"})];0<=_.indexOf(e.states,"image")&&this.states.add(t),0<=_.indexOf(e.states,"gallery")&&this.states.add(i),0<=_.indexOf(e.states,"video")&&this.states.add(a),0<=_.indexOf(e.states,"embed-code")&&this.states.add(r),LFM.has_featured_media&&this.states.add([new LFM.Controller.removeFeaturedMedia])},bindHandlers:function(){wp.media.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("menu:create:gallery",this.createMenu,this),this.on("toolbar:create:main-gallery",this.createToolbar,this),this.on("toolbar:create:featured-image",this.featuredImageToolbar,this),this.on("toolbar:create:main-embed",this.mainEmbedToolbar,this),_.each({menu:{default:"mainMenu",gallery:"galleryMenu"},content:{embed:"embedContent",video:"embedVideo","edit-image":"editImageContent","edit-selection":"editSelectionContent",remove:"removeFeaturedMedia"},toolbar:{"main-gallery":"mainGalleryToolbar","gallery-edit":"galleryEditToolbar","gallery-add":"galleryAddToolbar","remove-featured":"removeFeaturedToolbar"}},function(e,i){_.each(e,function(e,t){this.on(i+":render:"+t,this[e],this)},this)},this)},mainMenu:function(e){e.set({"library-separator":new wp.media.View({className:"separator",priority:100})})},removeFeaturedMedia:function(){var e=new LFM.Views.removeFeaturedView({controller:this,model:this.state()});this.content.set(e)},galleryMenu:function(e){var t=this;e.set({cancel:{text:i.cancelGalleryTitle,priority:20,click:function(){t.setState(t.state("gallery")),this.controller.modal.focusManager.focus()}},separateCancel:new wp.media.View({className:"separator",priority:40})})},embedVideo:function(){var e=new LFM.Views.featuredVideoView({controller:this,model:this.state()});this.content.set(e)},embedContent:function(){var e=new LFM.Views.featuredEmbedCodeView({controller:this,model:this.state()}).render();this.content.set(e)},editSelectionContent:function(){var e=this.state(),t=e.get("selection"),e=new wp.media.view.AttachmentsBrowser({controller:this,collection:t,selection:t,model:e,sortable:!0,search:!1,dragInfo:!0,AttachmentView:wp.media.view.Attachment.EditSelection}).render();e.toolbar.set("backToLibrary",{text:i.returnToLibrary,priority:-100,click:function(){this.controller.content.mode("browse")}}),this.content.set(e)},editImageContent:function(){var e=this.state().get("image"),e=new wp.media.view.EditImage({model:e,controller:this}).render();this.content.set(e),e.loadEditor()},selectionStatusToolbar:function(e){var t=this.state().get("editable");e.set("selection",new wp.media.view.Selection({controller:this,collection:this.state().get("selection"),priority:-40,editable:t&&function(){this.controller.content.mode("edit-selection")}}).render())},mainGalleryToolbar:function(e){var a=this;this.selectionStatusToolbar(e),e.set("gallery",{style:"primary",text:i.createNewGallery,priority:60,requires:{selection:!0},click:function(){var e=a.state().get("selection"),t=a.state("gallery-edit"),i=e.where({type:"image"});t.set("library",new wp.media.model.Selection(i,{props:e.props.toJSON(),multiple:!0})),this.controller.setState("gallery-edit"),this.controller.modal.focusManager.focus()}})},featuredImageToolbar:function(e){e.view=new LFM.Views.featuredImageToolbar({controller:this})},mainEmbedToolbar:function(e){e.view=new LFM.Views.defaultToolbar({controller:this})},galleryEditToolbar:function(){this.toolbar.set(new LFM.Views.defaultToolbar({controller:this}))},galleryAddToolbar:function(){this.toolbar.set(new wp.media.view.Toolbar({controller:this,items:{insert:{style:"primary",text:i.addToGallery,priority:80,requires:{selection:!0},click:function(){var e=this.controller,t=e.state();e.state("gallery-edit").get("library").add(t.get("selection").models),t.trigger("reset"),e.setState("gallery-edit")}}}}))},removeFeaturedToolbar:function(){this.toolbar.set(new LFM.Views.removeFeaturedToolbar({controller:this}))}}),LFM.Views.featuredBaseView=wp.media.View.extend({className:"featured-media-view"}),LFM.Views.featuredEmbeddableView=LFM.Views.featuredBaseView.extend({attachments:new wp.media.model.Attachments,initialize:function(){LFM.Views.featuredBaseView.prototype.initialize.apply(this,arguments);var e=this.controller.model;return this.controller.state().id===e.get("type")&&void 0!==e.get("attachment_data")||this.createUploader(),this},render:function(){LFM.Views.featuredBaseView.prototype.render.apply(this,arguments);var e=this.controller.model;return this.controller.state().id==e.get("type")&&void 0!==e.get("attachment_data")&&(e=new wp.media.model.Attachment(e.get("attachment_data")),this.updateThumbnail(e)),this},createUploader:function(){this.attachments.reset([]),this.attachments.observe(wp.Uploader.queue),this.attachments.on("change:uploading",this.uploadProgress.bind(this)),this.on("attachmentUploaded",this.attachmentUploaded.bind(this));var e=new wp.media.view.UploaderInline({controller:this.controller,status:!0,postId:null});this.views.add("#embed-thumb",e)},attachmentUploaded:function(){var e=this.attachments.first();this.updateThumbnail(e),this.off("attachmentUploaded"),this.attachments.off(),this.attachments.unobserve(wp.Uploader.queue)},updateThumbnail:function(e){var t=this;this.thumbnail=new LFM.Views.featuredThumbnail({el:this.$el.find("#embed-thumb"),model:e}).render(),this.thumbnail.on("remove",function(){t.createUploader(),t.thumbnail.off()}),this.attachments.unobserve(wp.Uploader.queue)},uploadProgress:function(){0==this.attachments.first().get("uploading")&&this.trigger("attachmentUploaded")}}),LFM.Views.featuredEmbedCodeView=LFM.Views.featuredEmbeddableView.extend({id:"media-editor-embed-code",template:wp.media.template("featured-embed-code")}),LFM.Views.featuredThumbnail=LFM.Views.featuredBaseView.extend({events:{"click a.remove-thumb":"removeThumb"},template:wp.media.template("featured-thumb"),removeThumb:function(e){l(e.currentTarget).parent().remove(),this.trigger("remove")}}),LFM.Views.featuredVideoView=LFM.Views.featuredEmbeddableView.extend({events:{"paste input.url":"fetchVideo","keypress input.url":"fetchVideo"},template:wp.media.template("featured-video"),fetchVideo:function(e){var t,i,a=this;error=a.$el.find("p.error"),error.html(""),allowedKeyCodes=[86,91,17],allowedLastKeys=[null,91,17],(e.keyCode in allowedKeyCodes||this.lastKey in allowedLastKeys)&&"paste"!=e.type||(void 0!==this.kp&&clearTimeout(this.kp),t=l('input[name="url"]'),i=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/,t.on("input propertychange",function(){a.kp=setTimeout(function(){var e=t.val();i.test(e)?a.fetchMeta(e):error.html(largo_featured_media_vars.error_invalid_url)},100)})),this.kp=e.keyCode},fetchMeta:function(e){var i=this;success=function(e){var t=i.$el.find("p.error");t.html(""),e.embed?i.$el.find("textarea").html(e.embed):t.html(largo_featured_media_vars.error_invalid_url),e.title&&i.$el.find('[name="title"]').val(e.title),e.author_name&&i.$el.find('[name="credit"]').val(e.author_name),i.$el.find('[name="attachment"]').length<1&&i.updateThumbnail(new Backbone.Model(e)),i.hideSpinner()},failure=function(){console.log(largo_featured_media_vars.error_occurred)},this.showSpinner(),LFM.Utils.doAjax("largo_fetch_video_oembed",{action:"largo_fetch_video_oembed",url:e},success,failure)},showSpinner:function(){this.$el.find(".spinner").removeAttr("style")},hideSpinner:function(){this.$el.find(".spinner").css({display:"none"})}}),LFM.Views.defaultToolbar=wp.media.view.Toolbar.extend({saving:!1,initialize:function(){_.defaults(this.options,{items:{submit:{style:"primary",priority:10,requires:!1,text:"Set as featured",click:this.save.bind(this)}}}),wp.media.view.Toolbar.prototype.initialize.apply(this,arguments),this.primary.$el.prepend('<span class="spinner" style="display: none;"></span>')},save:function(){var e,t,i,a,r;this.saving||(a={},"image"==(i=(t=(e=this).controller).state()).get("id")?(a.type="image",0<(r=i.get("selection").map(function(e){return e.get("id")})).length&&(wp.media.view.settings.post.featuredImageId=r[0],a.attachment=r[0])):"gallery-edit"==i.get("id")?(a.type="gallery",0<(r=i.get("library").map(function(e){return e.get("id")})).length&&(a.gallery=r)):a=LFM.Utils.formArrayToObj(t.$el.find("form").serializeArray()),this.saving=!0,this.showSpinner(),t.model=new s(a),t.model.save({},{success:function(){e.saving=!1,e.hideSpinner(),l("#set-featured-media-button").html("Edit Featured Media"),LFM.has_featured_media=!0,LFM.instances.modal.close()}}))},showSpinner:function(){this.$el.find(".spinner").removeAttr("style")},hideSpinner:function(){this.$el.find(".spinner").css({display:"none"})}}),LFM.Views.featuredImageToolbar=LFM.Views.defaultToolbar.extend({saving:!1,initialize:function(){_.defaults(this.options,{items:{submit:{style:"primary",priority:10,requires:{selection:!0},text:largo_featured_media_vars.set_featured,click:this.save.bind(this)}}}),LFM.Views.defaultToolbar.prototype.initialize.apply(this,arguments)},save:function(){var e,t;this.saving||((e=this).controller.state(),(t=LFM.Utils.formArrayToObj(this.secondary.$el.find("form").serializeArray())).id=LFM.Utils.getPostId(),void 0===t["featured-image-display"]?LFM.featured_image_display="":LFM.featured_image_display="on",this.showSpinner(),LFM.Utils.doAjax("largo_save_featured_image_display",t,function(){LFM.Views.defaultToolbar.prototype.save.apply(e,arguments)}))}}),LFM.Views.removeFeaturedToolbar=wp.media.view.Toolbar.extend({initialize:function(){_.defaults(this.options,{items:{submit:{style:"primary",priority:10,requires:!1,text:largo_featured_media_vars.confirm_remove_featured,click:this.clearFeatured.bind(this)}}}),wp.media.view.Toolbar.prototype.initialize.apply(this,arguments),this.primary.$el.prepend('<span class="spinner" style="display: none;"></span>')},clearFeatured:function(){var e=this,t=this.controller;this.showSpinner(),t.model=new s,t.model.save({},{success:function(){e.hideSpinner(),l("#set-featured-media-button").text("Set Featured Media"),LFM.instances.modal.close(),LFM.has_featured_media=!1,wp.media.view.settings.post.featuredImageId=-1}})},showSpinner:function(){this.$el.find(".spinner").removeAttr("style")},hideSpinner:function(){this.$el.find(".spinner").css({display:"none"})}}),LFM.Views.removeFeaturedView=wp.media.View.extend({className:"featured-remove-featured-confirm",template:wp.media.template("featured-remove-featured")}),LFM.Utils.formArrayToObj=function(e){var t={};return _.each(e,function(e){t[e.name]=e.value}),t},LFM.Utils.doAjax=function(e,t,a,r){t=JSON.stringify(t);params={url:ajaxurl,type:"POST",data:{action:e,data:t},dataType:"json",success:function(e,t,i){a&&a(e,t,i)},error:function(e,t,i){r&&r(e,t,i)}},l.ajax(params)},LFM.Utils.getPostId=function(){return Number(l("#post_ID").val())},LFM.Controller.removeFeaturedMedia=wp.media.controller.State.extend({defaults:{id:"remove",title:largo_featured_media_vars.remove_featured_title,content:"remove",menu:"default",toolbar:"remove-featured",priority:120,type:"link"},initialize:function(e){this.props=new Backbone.Model(this.metadata||{url:""})}}),l(document).ready(function(){l(".set-featured-media").click(function(){if(!LFM.fetching){var n=new s,o=l("#wp-content-media-buttons .spinner");return LFM.fetching=!0,o.show(),n.fetch({success:function(e){LFM.fetching=!1,o.hide();var t=wp.media.view.settings.post;"image"==e.get("type")&&0==t.id&&(t.featuredImageId=l("#featured_image_id").val());var i,a,e=e.get("type")||"image",r={state:_.findWhere(LFM.options,{id:e}).id,model:n,states:_.map(LFM.options,function(e){return e.id})};"gallery"==e?(r.state="gallery-edit",r.editing=!0,(a=new wp.media.model.Query([],{url:ajaxurl,args:{posts_per_page:-1,post__in:_.map(n.get("gallery"),function(e){return e})}})).on("sync",function(){var e=function(e,i){for(var a=[],r=0;r<e.length;r++)e.forEach(function(e,t){i[r]===e.id&&(a[r]=e)});return a}(a.models,a.args.post__in);r.selection=new wp.media.model.Selection(e,{multiple:!0}),(i=new LFM.Views.featuredMediaFrame(r)).open(),LFM.instances.modal=i,a.off("sync")}),a.fetch()):((i=new LFM.Views.featuredMediaFrame(r)).open(),LFM.instances.modal=i)}}),!1}})})}();